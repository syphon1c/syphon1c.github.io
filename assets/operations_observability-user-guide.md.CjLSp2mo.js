import{_ as n,o as e,c as l,ah as t,j as s,a as i}from"./chunks/framework.504LQ1l3.js";const g=JSON.parse('{"title":"Observability & Monitoring User Guide","description":"","frontmatter":{},"headers":[],"relativePath":"operations/observability-user-guide.md","filePath":"operations/observability-user-guide.md"}'),p={name:"operations/observability-user-guide.md"};function h(r,a,o,k,d,c){return e(),l("div",null,[...a[0]||(a[0]=[t(`<h1 id="observability-monitoring-user-guide" tabindex="-1">Observability &amp; Monitoring User Guide <a class="header-anchor" href="#observability-monitoring-user-guide" aria-label="Permalink to &quot;Observability &amp; Monitoring User Guide&quot;">​</a></h1><h2 id="observability-overview" tabindex="-1">Observability Overview <a class="header-anchor" href="#observability-overview" aria-label="Permalink to &quot;Observability Overview&quot;">​</a></h2><p>The AI Security Gateway provides comprehensive observability and monitoring capabilities through enhanced metrics and distributed tracing. This guide explains how to configure, access, and leverage these features to monitor system health, performance, and troubleshoot issues.</p><h2 id="observability-table-of-contents" tabindex="-1">Observability Table of Contents <a class="header-anchor" href="#observability-table-of-contents" aria-label="Permalink to &quot;Observability Table of Contents&quot;">​</a></h2><ol><li><a href="#enhanced-metrics">Enhanced Metrics</a></li><li><a href="#distributed-tracing">Distributed Tracing</a></li><li><a href="#integration-with-monitoring-systems">Integration with Monitoring Systems</a></li><li><a href="#best-practices">Best Practices</a></li><li><a href="#troubleshooting">Troubleshooting</a></li></ol><hr><h2 id="enhanced-metrics" tabindex="-1">Enhanced Metrics <a class="header-anchor" href="#enhanced-metrics" aria-label="Permalink to &quot;Enhanced Metrics&quot;">​</a></h2><h3 id="metrics-overview" tabindex="-1">Metrics Overview <a class="header-anchor" href="#metrics-overview" aria-label="Permalink to &quot;Metrics Overview&quot;">​</a></h3><p>Enhanced metrics provide detailed insights into system performance, including request durations, error rates, database query performance, proxy metrics, and policy evaluation statistics. All metrics are available via REST API and Prometheus-compatible endpoints.</p><h3 id="metrics-configuration" tabindex="-1">Metrics Configuration <a class="header-anchor" href="#metrics-configuration" aria-label="Permalink to &quot;Metrics Configuration&quot;">​</a></h3><p>Enhanced metrics are <strong>enabled by default</strong> and require no additional configuration. They automatically track:</p><ul><li><strong>Request Metrics</strong>: Total requests, errors, slow requests, duration percentiles (p50, p95, p99)</li><li><strong>Database Metrics</strong>: Total queries, slow queries, duration percentiles</li><li><strong>Error Metrics</strong>: Breakdown by endpoint and status code</li><li><strong>Proxy Metrics</strong>: Per-proxy request counts, success/error rates, duration</li><li><strong>Policy Metrics</strong>: Total evaluations, matches, misses, hit rate, per-policy details</li><li><strong>System Metrics</strong>: CPU, memory, goroutines</li><li><strong>Connection Pool Metrics</strong>: Utilization, wait counts, connection states</li><li><strong>Cache Metrics</strong>: Hits, misses, hit rate</li></ul><h3 id="accessing-metrics" tabindex="-1">Accessing Metrics <a class="header-anchor" href="#accessing-metrics" aria-label="Permalink to &quot;Accessing Metrics&quot;">​</a></h3><h4 id="_1-rest-api-endpoint" tabindex="-1">1. REST API Endpoint <a class="header-anchor" href="#_1-rest-api-endpoint" aria-label="Permalink to &quot;1. REST API Endpoint&quot;">​</a></h4><p><strong>Endpoint</strong>: <code>GET /api/v1/metrics</code></p><p><strong>Example Request</strong>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/api/v1/metrics</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Authorization: Bearer YOUR_JWT_TOKEN&quot;</span></span></code></pre></div><p><strong>Response Structure</strong>:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;data&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;request_metrics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;total_requests&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1250</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;total_errors&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">23</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;slow_requests&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;duration_p50&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;45ms&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;duration_p95&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;120ms&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;duration_p99&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;250ms&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;database_metrics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;total_queries&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3450</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;slow_queries&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;duration_p50&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2ms&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;duration_p95&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;8ms&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;duration_p99&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;15ms&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;error_metrics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;/api/v1/proxies&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;400&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;404&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;500&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;proxy_metrics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;proxy_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;proxy_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;MCP Server 1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;proxy_type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mcp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;requests_total&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">450</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;requests_success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">435</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;requests_error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">15</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;request_duration&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;125ms&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;last_request_time&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-01-15T10:30:00Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;policy_metrics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;total_evaluations&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;matches&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">125</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;misses&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12375</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;average_duration&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2ms&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;hit_rate_percent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;policy_details&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;malicious-prompt-detection&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          &quot;policy_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;malicious-prompt-detection&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          &quot;evaluations&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          &quot;matches&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          &quot;average_duration&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1.5ms&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;system_metrics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;cpu_usage_percent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">25.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;memory_usage_mb&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">512</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;goroutine_count&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">45</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;connection_pool_metrics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;open_connections&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;in_use&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;idle&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;wait_count&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;utilization_percent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;cache_metrics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;hits&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1250</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;misses&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">250</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;hit_rate&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">83.3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_2-prometheus-endpoint" tabindex="-1">2. Prometheus Endpoint <a class="header-anchor" href="#_2-prometheus-endpoint" aria-label="Permalink to &quot;2. Prometheus Endpoint&quot;">​</a></h4><p><strong>Endpoint</strong>: <code>GET /api/v1/metrics/prometheus</code></p><p><strong>Example Request</strong>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/api/v1/metrics/prometheus</span></span></code></pre></div><p><strong>Response Format</strong> (Prometheus text format):</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># HELP gateway_requests_total Total number of HTTP requests</span></span>
<span class="line"><span># TYPE gateway_requests_total counter</span></span>
<span class="line"><span>gateway_requests_total 1250</span></span>
<span class="line"><span></span></span>
<span class="line"><span># HELP gateway_request_duration_seconds Request duration in seconds</span></span>
<span class="line"><span># TYPE gateway_request_duration_seconds histogram</span></span>
<span class="line"><span>gateway_request_duration_seconds_bucket{le=&quot;0.005&quot;} 100</span></span>
<span class="line"><span>gateway_request_duration_seconds_bucket{le=&quot;0.01&quot;} 500</span></span>
<span class="line"><span>gateway_request_duration_seconds_bucket{le=&quot;0.05&quot;} 1000</span></span>
<span class="line"><span>gateway_request_duration_seconds_bucket{le=&quot;0.1&quot;} 1200</span></span>
<span class="line"><span>gateway_request_duration_seconds_bucket{le=&quot;+Inf&quot;} 1250</span></span>
<span class="line"><span>gateway_request_duration_seconds_sum 45.2</span></span>
<span class="line"><span>gateway_request_duration_seconds_count 1250</span></span>
<span class="line"><span></span></span>
<span class="line"><span># HELP gateway_errors_total Total number of errors by endpoint and status</span></span>
<span class="line"><span># TYPE gateway_errors_total counter</span></span>
<span class="line"><span>gateway_errors_total{endpoint=&quot;/api/v1/proxies&quot;,status=&quot;400&quot;} 5</span></span>
<span class="line"><span>gateway_errors_total{endpoint=&quot;/api/v1/proxies&quot;,status=&quot;500&quot;} 2</span></span>
<span class="line"><span></span></span>
<span class="line"><span># HELP gateway_proxy_requests_total Total proxy requests by proxy</span></span>
<span class="line"><span># TYPE gateway_proxy_requests_total counter</span></span>
<span class="line"><span>gateway_proxy_requests_total{proxy_id=&quot;1&quot;,proxy_name=&quot;MCP Server 1&quot;,proxy_type=&quot;mcp&quot;} 450</span></span>
<span class="line"><span></span></span>
<span class="line"><span># HELP gateway_policy_evaluations_total Total policy evaluations</span></span>
<span class="line"><span># TYPE gateway_policy_evaluations_total counter</span></span>
<span class="line"><span>gateway_policy_evaluations_total 12500</span></span>
<span class="line"><span>gateway_policy_evaluations_matches_total 125</span></span>
<span class="line"><span>gateway_policy_evaluations_misses_total 12375</span></span>
<span class="line"><span></span></span>
<span class="line"><span># HELP gateway_db_queries_total Total database queries</span></span>
<span class="line"><span># TYPE gateway_db_queries_total counter</span></span>
<span class="line"><span>gateway_db_queries_total 3450</span></span></code></pre></div><h4 id="_3-connection-pool-health-endpoint" tabindex="-1">3. Connection Pool Health Endpoint <a class="header-anchor" href="#_3-connection-pool-health-endpoint" aria-label="Permalink to &quot;3. Connection Pool Health Endpoint&quot;">​</a></h4><p><strong>Endpoint</strong>: <code>GET /api/v1/system/db/pool/health</code></p><p><strong>Example Request</strong>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/api/v1/system/db/pool/health</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Authorization: Bearer YOUR_JWT_TOKEN&quot;</span></span></code></pre></div><p><strong>Response</strong>:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;data&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;status&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;healthy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;utilization_percent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;open_connections&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;in_use&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;idle&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;wait_count&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Status Values</strong>:</p><ul><li><code>healthy</code> - Normal operation (&lt; 80% utilization, no waits)</li><li><code>degraded</code> - Elevated utilization (80-90%) or occasional waits</li><li><code>critical</code> - High utilization (&gt; 90%) or excessive waits</li></ul><h4 id="_4-connection-pool-stats-endpoint" tabindex="-1">4. Connection Pool Stats Endpoint <a class="header-anchor" href="#_4-connection-pool-stats-endpoint" aria-label="Permalink to &quot;4. Connection Pool Stats Endpoint&quot;">​</a></h4><p><strong>Endpoint</strong>: <code>GET /api/v1/system/db/pool/stats</code></p><p><strong>Example Request</strong>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/api/v1/system/db/pool/stats</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Authorization: Bearer YOUR_JWT_TOKEN&quot;</span></span></code></pre></div><p><strong>Response</strong>:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;data&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;max_open_connections&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">25</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;open_connections&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;in_use&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;idle&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;wait_count&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;wait_duration_ns&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;max_idle_closed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;max_lifetime_closed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;utilization_percent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30.0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="metrics-dashboard-integration" tabindex="-1">Metrics Dashboard Integration <a class="header-anchor" href="#metrics-dashboard-integration" aria-label="Permalink to &quot;Metrics Dashboard Integration&quot;">​</a></h3><h4 id="grafana-dashboard-setup" tabindex="-1">Grafana Dashboard Setup <a class="header-anchor" href="#grafana-dashboard-setup" aria-label="Permalink to &quot;Grafana Dashboard Setup&quot;">​</a></h4><ol><li><p><strong>Configure Prometheus Data Source</strong>:</p><ul><li>Add Prometheus as a data source in Grafana</li><li>URL: <code>http://your-gateway:8080/api/v1/metrics/prometheus</code></li></ul></li><li><p><strong>Example Queries</strong>:</p><p><strong>Request Rate</strong>:</p><div class="language-promql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">promql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>rate(gateway_requests_total[5m])</span></span></code></pre></div><p><strong>Error Rate</strong>:</p><div class="language-promql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">promql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>rate(gateway_errors_total[5m])</span></span></code></pre></div><p><strong>Request Duration (p95)</strong>:</p><div class="language-promql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">promql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>histogram_quantile(0.95, rate(gateway_request_duration_seconds_bucket[5m]))</span></span></code></pre></div><p><strong>Proxy Request Rate</strong>:</p><div class="language-promql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">promql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>rate(gateway_proxy_requests_total[5m])</span></span></code></pre></div><p><strong>Policy Hit Rate</strong>:</p><div class="language-promql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">promql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>rate(gateway_policy_evaluations_matches_total[5m]) / rate(gateway_policy_evaluations_total[5m]) * 100</span></span></code></pre></div><p><strong>Database Query Duration (p99)</strong>:</p><div class="language-promql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">promql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>histogram_quantile(0.99, rate(gateway_db_query_duration_seconds_bucket[5m]))</span></span></code></pre></div><p><strong>Connection Pool Utilization</strong>:</p><div class="language-promql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">promql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gateway_db_pool_utilization_percent</span></span></code></pre></div></li><li><p><strong>Recommended Dashboard Panels</strong>:</p><ul><li>Request rate (requests/second)</li><li>Error rate by endpoint</li><li>Request duration percentiles (p50, p95, p99)</li><li>Proxy request rates by proxy</li><li>Policy evaluation metrics</li><li>Database query performance</li><li>Connection pool utilization</li><li>System resource usage (CPU, memory, goroutines)</li></ul></li></ol><h3 id="using-metrics-for-monitoring" tabindex="-1">Using Metrics for Monitoring <a class="header-anchor" href="#using-metrics-for-monitoring" aria-label="Permalink to &quot;Using Metrics for Monitoring&quot;">​</a></h3><h4 id="alerting-rules-prometheus" tabindex="-1">Alerting Rules (Prometheus) <a class="header-anchor" href="#alerting-rules-prometheus" aria-label="Permalink to &quot;Alerting Rules (Prometheus)&quot;">​</a></h4><p>Example alerting rules you can configure in Prometheus:</p>`,45),s("div",null,[s("div",{class:"language-yaml vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"yaml"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0","v-pre":""},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"groups"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  - "),s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"name"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"gateway_alerts")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    rules"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"      # High error rate")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      - "),s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"alert"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"HighErrorRate")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        expr"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"rate(gateway_errors_total[5m]) > 0.1")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        for"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"5m")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        labels"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          severity"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"warning")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        annotations"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          summary"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"High error rate detected"')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          description"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Error rate is {{ $value }} errors/second"')]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"      # Slow requests")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      - "),s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"alert"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"SlowRequests")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        expr"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"histogram_quantile(0.95, rate(gateway_request_duration_seconds_bucket[5m])) > 1")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        for"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"5m")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        labels"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          severity"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"warning")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        annotations"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          summary"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Slow requests detected"')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          description"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"95th percentile request duration is {{ $value }}s"')]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"      # Connection pool exhaustion")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      - "),s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"alert"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"ConnectionPoolExhaustion")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        expr"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"gateway_db_pool_utilization_percent > 90")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        for"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"2m")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        labels"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          severity"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"critical")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        annotations"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          summary"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Connection pool near exhaustion"')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          description"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Pool utilization is {{ $value }}%"')]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"      # High policy evaluation time")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"      - "),s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"alert"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"SlowPolicyEvaluation")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        expr"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"gateway_policy_evaluation_duration_seconds > 0.1")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        for"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"5m")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        labels"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          severity"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"warning")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"        annotations"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          summary"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Slow policy evaluation"')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"          description"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Policy evaluation taking {{ $value }}s"')])])])])],-1),t(`<hr><h2 id="distributed-tracing" tabindex="-1">Distributed Tracing <a class="header-anchor" href="#distributed-tracing" aria-label="Permalink to &quot;Distributed Tracing&quot;">​</a></h2><h3 id="tracing-overview" tabindex="-1">Tracing Overview <a class="header-anchor" href="#tracing-overview" aria-label="Permalink to &quot;Tracing Overview&quot;">​</a></h3><p>Distributed tracing provides end-to-end visibility into request flows across handlers, services, and repositories. This helps debug issues, understand performance bottlenecks, and trace request paths through the system.</p><h3 id="tracing-configuration" tabindex="-1">Tracing Configuration <a class="header-anchor" href="#tracing-configuration" aria-label="Permalink to &quot;Tracing Configuration&quot;">​</a></h3><p>Tracing is <strong>disabled by default</strong> and must be explicitly enabled via environment variables.</p><h4 id="environment-variables" tabindex="-1">Environment Variables <a class="header-anchor" href="#environment-variables" aria-label="Permalink to &quot;Environment Variables&quot;">​</a></h4><table tabindex="0"><thead><tr><th>Variable</th><th>Description</th><th>Default</th><th>Example</th></tr></thead><tbody><tr><td><code>TRACING_ENABLED</code></td><td>Enable/disable tracing</td><td><code>false</code></td><td><code>true</code></td></tr><tr><td><code>TRACING_SERVICE_NAME</code></td><td>Service name for traces</td><td><code>ai-security-gateway</code></td><td><code>ai-security-gateway</code></td></tr><tr><td><code>TRACING_ENVIRONMENT</code></td><td>Environment name</td><td><code>development</code></td><td><code>production</code></td></tr><tr><td><code>TRACING_JAEGER_URL</code></td><td>Jaeger collector endpoint</td><td>-</td><td><code>http://localhost:14268/api/traces</code></td></tr><tr><td><code>TRACING_OTLP_ENDPOINT</code></td><td>OTLP HTTP endpoint</td><td>-</td><td><code>http://localhost:4318</code></td></tr><tr><td><code>TRACING_SAMPLE_RATE</code></td><td>Sampling rate (0.0-1.0)</td><td><code>1.0</code></td><td><code>0.1</code> (10% sampling)</td></tr></tbody></table><h3 id="setup-instructions" tabindex="-1">Setup Instructions <a class="header-anchor" href="#setup-instructions" aria-label="Permalink to &quot;Setup Instructions&quot;">​</a></h3><h4 id="option-1-jaeger-quick-start" tabindex="-1">Option 1: Jaeger (Quick Start) <a class="header-anchor" href="#option-1-jaeger-quick-start" aria-label="Permalink to &quot;Option 1: Jaeger (Quick Start)&quot;">​</a></h4><ol><li><p><strong>Start Jaeger</strong>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jaeger</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 16686:16686</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 14268:14268</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  jaegertracing/all-in-one:latest</span></span></code></pre></div></li><li><p><strong>Configure Gateway</strong>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_ENABLED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_JAEGER_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://localhost:14268/api/traces</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_SERVICE_NAME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ai-security-gateway</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_ENVIRONMENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">development</span></span></code></pre></div></li><li><p><strong>View Traces</strong>:</p><ul><li>Open Jaeger UI: <a href="http://localhost:16686" target="_blank" rel="noreferrer">http://localhost:16686</a></li><li>Select service: <code>ai-security-gateway</code></li><li>Search for traces</li></ul></li></ol><h4 id="option-2-otlp-opentelemetry-protocol" tabindex="-1">Option 2: OTLP (OpenTelemetry Protocol) <a class="header-anchor" href="#option-2-otlp-opentelemetry-protocol" aria-label="Permalink to &quot;Option 2: OTLP (OpenTelemetry Protocol)&quot;">​</a></h4><ol><li><p><strong>Start OTLP Collector</strong>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> otel-collector</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 4318:4318</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -v</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/otel-collector-config.yaml:/etc/otel-collector-config.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  otel/opentelemetry-collector:latest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --config=/etc/otel-collector-config.yaml</span></span></code></pre></div></li><li><p><strong>Configure Gateway</strong>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_ENABLED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_OTLP_ENDPOINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://localhost:4318</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_SERVICE_NAME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ai-security-gateway</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_ENVIRONMENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">production</span></span></code></pre></div></li><li><p><strong>OTLP Collector Configuration</strong> (<code>otel-collector-config.yaml</code>):</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">receivers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  otlp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    protocols</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        endpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">0.0.0.0:4318</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">exporters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  jaeger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    endpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">jaeger:14250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  logging</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    loglevel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">debug</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  pipelines</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    traces</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      receivers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">otlp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      exporters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">jaeger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">logging</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div></li></ol><h3 id="how-tracing-works" tabindex="-1">How Tracing Works <a class="header-anchor" href="#how-tracing-works" aria-label="Permalink to &quot;How Tracing Works&quot;">​</a></h3><h4 id="automatic-tracing" tabindex="-1">Automatic Tracing <a class="header-anchor" href="#automatic-tracing" aria-label="Permalink to &quot;Automatic Tracing&quot;">​</a></h4><p>All HTTP requests are <strong>automatically traced</strong> via middleware. No additional code is required for basic request tracing.</p><p><strong>What&#39;s Captured</strong>:</p><ul><li>Request method, URL, path</li><li>Request headers (user agent, remote address)</li><li>Response status code</li><li>Response size</li><li>Request duration</li><li>Errors (if any)</li></ul><h4 id="trace-context-propagation" tabindex="-1">Trace Context Propagation <a class="header-anchor" href="#trace-context-propagation" aria-label="Permalink to &quot;Trace Context Propagation&quot;">​</a></h4><p>Trace context is automatically propagated through:</p><ul><li>HTTP handlers → Services → Repositories</li><li>All function calls that accept <code>context.Context</code></li><li>Database queries</li><li>Policy evaluations</li><li>Proxy requests</li></ul><h4 id="trace-structure" tabindex="-1">Trace Structure <a class="header-anchor" href="#trace-structure" aria-label="Permalink to &quot;Trace Structure&quot;">​</a></h4><p>A typical trace looks like this:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>http.request (root span)</span></span>
<span class="line"><span>├── service.MultiProxyService.ListProxyConfigs</span></span>
<span class="line"><span>│   └── repo.ProxyConfigRepository.List</span></span>
<span class="line"><span>│       └── db.query (SELECT * FROM proxy_configs...)</span></span>
<span class="line"><span>├── service.DashboardService.GetPolicies</span></span>
<span class="line"><span>│   └── repo.PolicyRepository.GetActiveStatusBatch</span></span>
<span class="line"><span>│       └── db.query (SELECT name, active FROM policies...)</span></span>
<span class="line"><span>└── service.PolicyAssignmentService.GetEnabledAssignments</span></span>
<span class="line"><span>    └── repo.PolicyAssignmentRepository.GetByProxyID</span></span>
<span class="line"><span>        └── db.query (SELECT * FROM policy_assignments...)</span></span></code></pre></div><h3 id="viewing-traces" tabindex="-1">Viewing Traces <a class="header-anchor" href="#viewing-traces" aria-label="Permalink to &quot;Viewing Traces&quot;">​</a></h3><h4 id="jaeger-ui" tabindex="-1">Jaeger UI <a class="header-anchor" href="#jaeger-ui" aria-label="Permalink to &quot;Jaeger UI&quot;">​</a></h4><ol><li><p><strong>Access Jaeger UI</strong>: <a href="http://localhost:16686" target="_blank" rel="noreferrer">http://localhost:16686</a></p></li><li><p><strong>Search for Traces</strong>:</p><ul><li>Select service: <code>ai-security-gateway</code></li><li>Choose time range</li><li>Optionally filter by operation, tags, or duration</li></ul></li><li><p><strong>View Trace Details</strong>:</p><ul><li>Click on a trace to see the full span tree</li><li>View span attributes (request details, errors, etc.)</li><li>See timing breakdown for each operation</li></ul></li><li><p><strong>Example Trace View</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Trace: abc123def456</span></span>
<span class="line"><span>Duration: 45ms</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[http.request] 45ms</span></span>
<span class="line"><span>  ├─ [service.MultiProxyService.ListProxyConfigs] 30ms</span></span>
<span class="line"><span>  │   └─ [repo.ProxyConfigRepository.List] 25ms</span></span>
<span class="line"><span>  │       └─ [db.query] 20ms</span></span>
<span class="line"><span>  └─ [service.DashboardService.GetPolicies] 10ms</span></span>
<span class="line"><span>      └─ [repo.PolicyRepository.GetActiveStatusBatch] 8ms</span></span></code></pre></div></li></ol><h4 id="trace-attributes" tabindex="-1">Trace Attributes <a class="header-anchor" href="#trace-attributes" aria-label="Permalink to &quot;Trace Attributes&quot;">​</a></h4><p>Each span includes relevant attributes:</p><p><strong>HTTP Request Spans</strong>:</p><ul><li><code>http.method</code>: HTTP method (GET, POST, etc.)</li><li><code>http.url</code>: Full request URL</li><li><code>http.route</code>: Route path</li><li><code>http.status_code</code>: Response status code</li><li><code>http.response.size</code>: Response size in bytes</li><li><code>http.user_agent</code>: Client user agent</li><li><code>http.remote_addr</code>: Client IP address</li></ul><p><strong>Service Spans</strong>:</p><ul><li><code>service.name</code>: Service name</li><li><code>service.method</code>: Method name</li></ul><p><strong>Repository Spans</strong>:</p><ul><li><code>repository.name</code>: Repository name</li><li><code>repository.method</code>: Method name</li></ul><p><strong>Database Spans</strong>:</p><ul><li><code>db.operation</code>: Operation type (SELECT, INSERT, etc.)</li><li><code>db.statement</code>: SQL query (sanitized)</li><li><code>db.sql.table</code>: Table name</li></ul><p><strong>Policy Spans</strong>:</p><ul><li><code>policy.name</code>: Policy name</li><li><code>policy.matched</code>: Whether policy matched</li></ul><p><strong>Proxy Spans</strong>:</p><ul><li><code>proxy.id</code>: Proxy ID</li><li><code>proxy.name</code>: Proxy name</li><li><code>proxy.type</code>: Proxy type (mcp, llm)</li></ul><h3 id="sampling-configuration" tabindex="-1">Sampling Configuration <a class="header-anchor" href="#sampling-configuration" aria-label="Permalink to &quot;Sampling Configuration&quot;">​</a></h3><p>For high-traffic scenarios, configure sampling to reduce trace volume:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Sample 10% of requests</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_SAMPLE_RATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Sample 50% of requests</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_SAMPLE_RATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.5</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Sample all requests (default)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_SAMPLE_RATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.0</span></span></code></pre></div><p><strong>Sampling Strategy</strong>:</p><ul><li>Use <code>1.0</code> (100%) for development and low-traffic production</li><li>Use <code>0.1</code> (10%) for high-traffic production</li><li>Use <code>0.01</code> (1%) for very high-traffic scenarios</li></ul><h3 id="trace-context-in-logs" tabindex="-1">Trace Context in Logs <a class="header-anchor" href="#trace-context-in-logs" aria-label="Permalink to &quot;Trace Context in Logs&quot;">​</a></h3><p>Trace IDs and Span IDs are automatically included in structured logs when available. This allows correlating logs with traces.</p><p><strong>Example Log Entry</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>2025-01-15 10:30:00 INFO [api-server] Failed to list proxy configurations: database connection timeout</span></span>
<span class="line"><span>  trace_id=abc123def456</span></span>
<span class="line"><span>  span_id=789xyz012</span></span></code></pre></div><p><strong>Extracting Trace Context</strong> (for custom logging):</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">github.com/syphon1c/ai-security-gateway-beta/internal/tracing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">traceID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tracing.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TraceIDFromContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">spanID </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tracing.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SpanIDFromContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Operation completed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;trace_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, traceID, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;span_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, spanID)</span></span></code></pre></div><hr><h2 id="integration-with-monitoring-systems" tabindex="-1">Integration with Monitoring Systems <a class="header-anchor" href="#integration-with-monitoring-systems" aria-label="Permalink to &quot;Integration with Monitoring Systems&quot;">​</a></h2><h3 id="prometheus-grafana" tabindex="-1">Prometheus + Grafana <a class="header-anchor" href="#prometheus-grafana" aria-label="Permalink to &quot;Prometheus + Grafana&quot;">​</a></h3><h4 id="_1-configure-prometheus" tabindex="-1">1. Configure Prometheus <a class="header-anchor" href="#_1-configure-prometheus" aria-label="Permalink to &quot;1. Configure Prometheus&quot;">​</a></h4><p><strong><code>prometheus.yml</code></strong>:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">scrape_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">job_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ai-security-gateway&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    scrape_interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">15s</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    metrics_path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/api/v1/metrics/prometheus&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    static_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">targets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;localhost:8080&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><h4 id="_2-start-prometheus" tabindex="-1">2. Start Prometheus <a class="header-anchor" href="#_2-start-prometheus" aria-label="Permalink to &quot;2. Start Prometheus&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 9090:9090</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -v</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/prometheus.yml:/etc/prometheus/prometheus.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  prom/prometheus:latest</span></span></code></pre></div><h4 id="_3-create-grafana-dashboard" tabindex="-1">3. Create Grafana Dashboard <a class="header-anchor" href="#_3-create-grafana-dashboard" aria-label="Permalink to &quot;3. Create Grafana Dashboard&quot;">​</a></h4><p>Import the following dashboard JSON or create panels manually:</p><p><strong>Key Panels</strong>:</p><ul><li>Request rate over time</li><li>Error rate by endpoint</li><li>Request duration percentiles</li><li>Proxy metrics by proxy</li><li>Policy evaluation metrics</li><li>Database query performance</li><li>Connection pool health</li><li>System resource usage</li></ul><h3 id="datadog-integration" tabindex="-1">Datadog Integration <a class="header-anchor" href="#datadog-integration" aria-label="Permalink to &quot;Datadog Integration&quot;">​</a></h3><h4 id="_1-configure-datadog-otlp-exporter" tabindex="-1">1. Configure Datadog OTLP Exporter <a class="header-anchor" href="#_1-configure-datadog-otlp-exporter" aria-label="Permalink to &quot;1. Configure Datadog OTLP Exporter&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_ENABLED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_OTLP_ENDPOINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">https://trace-intake.datadoghq.com</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_SERVICE_NAME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ai-security-gateway</span></span></code></pre></div><h4 id="_2-configure-datadog-agent" tabindex="-1">2. Configure Datadog Agent <a class="header-anchor" href="#_2-configure-datadog-agent" aria-label="Permalink to &quot;2. Configure Datadog Agent&quot;">​</a></h4><p>The Datadog agent will receive traces via OTLP and forward them to Datadog.</p><h3 id="new-relic-integration" tabindex="-1">New Relic Integration <a class="header-anchor" href="#new-relic-integration" aria-label="Permalink to &quot;New Relic Integration&quot;">​</a></h3><h4 id="_1-configure-new-relic-otlp-exporter" tabindex="-1">1. Configure New Relic OTLP Exporter <a class="header-anchor" href="#_1-configure-new-relic-otlp-exporter" aria-label="Permalink to &quot;1. Configure New Relic OTLP Exporter&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_ENABLED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_OTLP_ENDPOINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">https://otlp.nr-data.net:4318</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_SERVICE_NAME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ai-security-gateway</span></span></code></pre></div><h4 id="_2-add-api-key-header" tabindex="-1">2. Add API Key Header <a class="header-anchor" href="#_2-add-api-key-header" aria-label="Permalink to &quot;2. Add API Key Header&quot;">​</a></h4><p>Modify <code>internal/tracing/tracer.go</code> to include New Relic API key in OTLP headers.</p><h3 id="custom-observability-backend" tabindex="-1">Custom Observability Backend <a class="header-anchor" href="#custom-observability-backend" aria-label="Permalink to &quot;Custom Observability Backend&quot;">​</a></h3><p>Any OTLP-compatible backend can be used:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_ENABLED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_OTLP_ENDPOINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://your-otel-backend:4318</span></span></code></pre></div><hr><h2 id="best-practices" tabindex="-1">Best Practices <a class="header-anchor" href="#best-practices" aria-label="Permalink to &quot;Best Practices&quot;">​</a></h2><h3 id="metrics" tabindex="-1">Metrics <a class="header-anchor" href="#metrics" aria-label="Permalink to &quot;Metrics&quot;">​</a></h3><ol><li><p><strong>Monitor Key Metrics</strong>:</p><ul><li>Request rate and error rate</li><li>Request duration percentiles (p95, p99)</li><li>Database query performance</li><li>Connection pool utilization</li><li>Policy evaluation performance</li></ul></li><li><p><strong>Set Up Alerts</strong>:</p><ul><li>High error rates (&gt; 1% of requests)</li><li>Slow requests (p95 &gt; 1s)</li><li>Connection pool exhaustion (&gt; 90% utilization)</li><li>High database query times</li></ul></li><li><p><strong>Regular Review</strong>:</p><ul><li>Review metrics dashboard daily</li><li>Investigate error spikes</li><li>Monitor proxy performance trends</li><li>Track policy effectiveness</li></ul></li></ol><h3 id="tracing" tabindex="-1">Tracing <a class="header-anchor" href="#tracing" aria-label="Permalink to &quot;Tracing&quot;">​</a></h3><ol><li><p><strong>Sampling Strategy</strong>:</p><ul><li>Use 100% sampling in development</li><li>Use 10-50% sampling in production</li><li>Adjust based on traffic volume</li></ul></li><li><p><strong>Trace Analysis</strong>:</p><ul><li>Focus on slow traces (&gt; 1s)</li><li>Investigate traces with errors</li><li>Compare trace durations over time</li><li>Identify bottlenecks in span trees</li></ul></li><li><p><strong>Performance Optimization</strong>:</p><ul><li>Use trace data to identify slow operations</li><li>Optimize database queries that appear frequently</li><li>Review service call patterns</li><li>Identify N+1 query patterns</li></ul></li></ol><h3 id="security-considerations" tabindex="-1">Security Considerations <a class="header-anchor" href="#security-considerations" aria-label="Permalink to &quot;Security Considerations&quot;">​</a></h3><ol><li><p><strong>Sensitive Data</strong>:</p><ul><li>Traces may contain request/response data</li><li>Ensure trace data is stored securely</li><li>Consider data retention policies</li><li>Sanitize sensitive information in spans</li></ul></li><li><p><strong>Access Control</strong>:</p><ul><li>Restrict access to metrics endpoints in production</li><li>Use authentication for Prometheus endpoint</li><li>Limit trace export to authorized backends</li></ul></li></ol><hr><h2 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-label="Permalink to &quot;Troubleshooting&quot;">​</a></h2><h3 id="metrics-not-appearing" tabindex="-1">Metrics Not Appearing <a class="header-anchor" href="#metrics-not-appearing" aria-label="Permalink to &quot;Metrics Not Appearing&quot;">​</a></h3><p><strong>Problem</strong>: Metrics endpoint returns empty or no data.</p><p><strong>Solutions</strong>:</p><ol><li>Verify metrics middleware is registered (should be automatic)</li><li>Check that requests are being made (metrics are request-driven)</li><li>Ensure sufficient time has passed for metrics to accumulate</li><li>Check logs for metrics-related errors</li></ol><h3 id="prometheus-scraping-fails" tabindex="-1">Prometheus Scraping Fails <a class="header-anchor" href="#prometheus-scraping-fails" aria-label="Permalink to &quot;Prometheus Scraping Fails&quot;">​</a></h3><p><strong>Problem</strong>: Prometheus cannot scrape metrics endpoint.</p><p><strong>Solutions</strong>:</p><ol><li>Verify endpoint is accessible: <code>curl http://localhost:8080/api/v1/metrics/prometheus</code></li><li>Check Prometheus configuration (correct URL and path)</li><li>Verify network connectivity between Prometheus and gateway</li><li>Check for authentication requirements</li></ol><h3 id="traces-not-appearing-in-jaeger" tabindex="-1">Traces Not Appearing in Jaeger <a class="header-anchor" href="#traces-not-appearing-in-jaeger" aria-label="Permalink to &quot;Traces Not Appearing in Jaeger&quot;">​</a></h3><p><strong>Problem</strong>: Traces are not showing up in Jaeger UI.</p><p><strong>Solutions</strong>:</p><ol><li>Verify <code>TRACING_ENABLED=true</code> is set</li><li>Check Jaeger URL is correct and accessible</li><li>Verify Jaeger collector is running: <code>docker ps | grep jaeger</code></li><li>Check gateway logs for tracing initialization errors</li><li>Verify sampling rate is not too low</li><li>Wait a few seconds for traces to be exported (batched)</li></ol><h3 id="high-memory-usage-from-tracing" tabindex="-1">High Memory Usage from Tracing <a class="header-anchor" href="#high-memory-usage-from-tracing" aria-label="Permalink to &quot;High Memory Usage from Tracing&quot;">​</a></h3><p><strong>Problem</strong>: Tracing causes high memory usage.</p><p><strong>Solutions</strong>:</p><ol><li>Reduce sampling rate: <code>export TRACING_SAMPLE_RATE=0.1</code></li><li>Ensure exporter is running and consuming traces</li><li>Check for span leaks (spans not being ended)</li><li>Restart gateway if memory usage is excessive</li></ol><h3 id="missing-trace-context" tabindex="-1">Missing Trace Context <a class="header-anchor" href="#missing-trace-context" aria-label="Permalink to &quot;Missing Trace Context&quot;">​</a></h3><p><strong>Problem</strong>: Trace context is not propagated through request chain.</p><p><strong>Solutions</strong>:</p><ol><li>Ensure middleware is registered before other middleware</li><li>Verify <code>context.Context</code> is passed through all function calls</li><li>Check that child spans are created from parent context</li><li>Review code to ensure context propagation is maintained</li></ol><h3 id="connection-pool-alerts" tabindex="-1">Connection Pool Alerts <a class="header-anchor" href="#connection-pool-alerts" aria-label="Permalink to &quot;Connection Pool Alerts&quot;">​</a></h3><p><strong>Problem</strong>: Receiving connection pool exhaustion alerts.</p><p><strong>Solutions</strong>:</p><ol><li>Check connection pool stats endpoint for details</li><li>Review database query patterns for long-running queries</li><li>Increase <code>MaxOpenConns</code> in database configuration if needed</li><li>Optimize slow queries</li><li>Check for connection leaks (connections not being closed)</li></ol><hr><h2 id="example-use-cases" tabindex="-1">Example Use Cases <a class="header-anchor" href="#example-use-cases" aria-label="Permalink to &quot;Example Use Cases&quot;">​</a></h2><h3 id="use-case-1-debugging-slow-api-endpoint" tabindex="-1">Use Case 1: Debugging Slow API Endpoint <a class="header-anchor" href="#use-case-1-debugging-slow-api-endpoint" aria-label="Permalink to &quot;Use Case 1: Debugging Slow API Endpoint&quot;">​</a></h3><p><strong>Scenario</strong>: <code>/api/v1/proxies</code> endpoint is slow.</p><p><strong>Steps</strong>:</p><ol><li>Check metrics: <code>GET /api/v1/metrics</code> → Look at <code>request_metrics.duration_p95</code> for <code>/api/v1/proxies</code></li><li>View trace in Jaeger: Search for traces with operation <code>GET /api/v1/proxies</code></li><li>Analyze span tree: Identify which service/repository call is slow</li><li>Review database queries: Check <code>db.query</code> spans for slow queries</li><li>Optimize: Fix slow queries or add caching</li></ol><h3 id="use-case-2-monitoring-proxy-performance" tabindex="-1">Use Case 2: Monitoring Proxy Performance <a class="header-anchor" href="#use-case-2-monitoring-proxy-performance" aria-label="Permalink to &quot;Use Case 2: Monitoring Proxy Performance&quot;">​</a></h3><p><strong>Scenario</strong>: Monitor performance of specific proxy instances.</p><p><strong>Steps</strong>:</p><ol><li>Query proxy metrics: <code>GET /api/v1/metrics</code> → <code>proxy_metrics[proxy_id]</code></li><li>Set up Grafana dashboard: Create panel for <code>gateway_proxy_requests_total{proxy_id=&quot;1&quot;}</code></li><li>Configure alerts: Alert when error rate &gt; 5% or duration &gt; 500ms</li><li>Review traces: Filter traces by <code>proxy.id</code> attribute</li></ol><h3 id="use-case-3-policy-effectiveness-analysis" tabindex="-1">Use Case 3: Policy Effectiveness Analysis <a class="header-anchor" href="#use-case-3-policy-effectiveness-analysis" aria-label="Permalink to &quot;Use Case 3: Policy Effectiveness Analysis&quot;">​</a></h3><p><strong>Scenario</strong>: Analyze which policies are most effective.</p><p><strong>Steps</strong>:</p><ol><li>Query policy metrics: <code>GET /api/v1/metrics</code> → <code>policy_metrics.policy_details</code></li><li>Calculate hit rates: <code>matches / evaluations * 100</code></li><li>Identify top policies: Sort by match count or hit rate</li><li>Review policy traces: Filter traces by <code>policy.name</code> attribute</li><li>Optimize: Tune policies with low hit rates or high evaluation times</li></ol><h3 id="use-case-4-database-performance-tuning" tabindex="-1">Use Case 4: Database Performance Tuning <a class="header-anchor" href="#use-case-4-database-performance-tuning" aria-label="Permalink to &quot;Use Case 4: Database Performance Tuning&quot;">​</a></h3><p><strong>Scenario</strong>: Optimize database query performance.</p><p><strong>Steps</strong>:</p><ol><li>Check database metrics: <code>GET /api/v1/metrics</code> → <code>database_metrics</code></li><li>Identify slow queries: Review traces with <code>db.query</code> spans &gt; 100ms</li><li>Analyze query patterns: Look for N+1 query patterns in traces</li><li>Optimize: Add indexes, batch queries, or add caching</li><li>Monitor improvements: Track <code>database_metrics.duration_p95</code> over time</li></ol><hr><h2 id="quick-reference" tabindex="-1">Quick Reference <a class="header-anchor" href="#quick-reference" aria-label="Permalink to &quot;Quick Reference&quot;">​</a></h2><h3 id="environment-variables-1" tabindex="-1">Environment Variables <a class="header-anchor" href="#environment-variables-1" aria-label="Permalink to &quot;Environment Variables&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Metrics (always enabled, no config needed)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Tracing</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_ENABLED</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_SERVICE_NAME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ai-security-gateway</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_ENVIRONMENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">production</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_JAEGER_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://localhost:14268/api/traces</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># OR</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_OTLP_ENDPOINT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://localhost:4318</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TRACING_SAMPLE_RATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.1</span></span></code></pre></div><h3 id="api-endpoints" tabindex="-1">API Endpoints <a class="header-anchor" href="#api-endpoints" aria-label="Permalink to &quot;API Endpoints&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Endpoint</th><th>Method</th><th>Description</th><th>Auth Required</th></tr></thead><tbody><tr><td><code>/api/v1/metrics</code></td><td>GET</td><td>Get all metrics (JSON)</td><td>Yes</td></tr><tr><td><code>/api/v1/metrics/prometheus</code></td><td>GET</td><td>Prometheus metrics</td><td>No</td></tr><tr><td><code>/api/v1/system/db/pool/health</code></td><td>GET</td><td>Connection pool health</td><td>Yes</td></tr><tr><td><code>/api/v1/system/db/pool/stats</code></td><td>GET</td><td>Connection pool stats</td><td>Yes</td></tr></tbody></table><h3 id="docker-compose-example" tabindex="-1">Docker Compose Example <a class="header-anchor" href="#docker-compose-example" aria-label="Permalink to &quot;Docker Compose Example&quot;">​</a></h3><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;3.8&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  gateway</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ai-security-gateway:latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;8080:8080&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    environment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TRACING_ENABLED=true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TRACING_JAEGER_URL=http://jaeger:14268/api/traces</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TRACING_SERVICE_NAME=ai-security-gateway</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TRACING_ENVIRONMENT=production</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TRACING_SAMPLE_RATE=0.1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  jaeger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">jaegertracing/all-in-one:latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;16686:16686&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # UI</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;14268:14268&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Collector</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  prometheus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">prom/prometheus:latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;9090:9090&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./prometheus.yml:/etc/prometheus/prometheus.yml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  grafana</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">grafana/grafana:latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;3000:3000&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    environment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">GF_SECURITY_ADMIN_PASSWORD=admin</span></span></code></pre></div><hr><h2 id="support" tabindex="-1">Support <a class="header-anchor" href="#support" aria-label="Permalink to &quot;Support&quot;">​</a></h2><p>For additional help:</p><ul><li>Review <code>docs/tracing-guide.md</code> for detailed tracing documentation</li><li>Check gateway logs for errors</li><li>Review metrics endpoint responses for system status</li><li>Consult OpenTelemetry documentation for advanced tracing configuration</li></ul>`,141)])])}const u=n(p,[["render",h]]);export{g as __pageData,u as default};
